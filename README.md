# Сервис интеграции Edna <> amoCRM

Этот сервис работает как промежуточное ПО (middleware) для обеспечения двусторонней связи между платформой обмена сообщениями edna Pulse и Чатами amoCRM. Он маршрутизирует сообщения, медиафайлы и обновления статусов между двумя системами.

## Возможности

- **Двусторонняя маршрутизация сообщений**: Сообщения от клиентов в edna доставляются в чаты amoCRM, а сообщения от операторов в amoCRM отправляются клиентам через edna.
- **Поддержка медиафайлов**: Обрабатывает изображения и вложенные файлы.
- **Синхронизация статусов**: Синхронизирует статусы сообщений (отправлено, доставлено, прочитано) из edna в amoCRM.
- **Чистая архитектура**: Проект построен на принципах Чистой архитектуры для упрощения поддержки и тестирования.
- **Контейнеризация**: Готов к развертыванию в виде Docker-контейнера.

## Архитектура

Приложение следует классической структуре Чистой архитектуры, разделяя логику на четыре основных слоя:

- `domain`: Содержит основную бизнес-логику, сущности (например, `Message`) и интерфейсы (порты).
- `use_cases`: Оркестрирует поток данных между доменом и инфраструктурными слоями.
- `infrastructure`: Реализует компоненты, взаимодействующие с внешним миром, такие как HTTP-клиенты и репозитории.
- `presentation`: Предоставляет доступ к приложению извне через REST API (FastAPI), определяя схемы и обрабатывая веб-запросы.

## API Эндпоинты

Сервис предоставляет следующие эндпоинты. Для получения подробной информации о моделях запросов/ответов обратитесь к автоматически сгенерированной документации OpenAPI по адресу `/docs` во время работы сервиса.

### Проверка состояния

- `GET /health`
  - **Описание**: Проверяет, запущен ли и доступен ли сервис.
  - **Успешный ответ (200 OK)**:
    ```json
    {
      "status": "ok"
    }
    ```

### Вебхуки

- `POST /webhooks/edna`
  - **Описание**: Получает входящие сообщения и обновления статусов от платформы edna Pulse.
  - **Тело запроса**: Может быть одного из двух типов: `EdnaIncomingMessage` или `EdnaStatusUpdate`.
  - **Успешный ответ (200 OK)**:
    ```json
    {
      "code": "ok"
    }
    ```


- `POST /webhooks/amocrm`
  - **Описание**: Получает новые сообщения, отправленные операторами из чата amoCRM.
  - **Тело запроса**: `AmoIncomingWebhook`.
  - **Успешный ответ (200 OK)**:
    ```json
    {
      "code": "ok"
    }
    ```

## Конфигурация

Сервис настраивается с помощью переменных окружения. Создайте файл `.env` в корне проекта, скопировав `.env.sample` и заполнив значения.

### Edna

| Переменная | Описание | Значение по умолчанию |
| --- | --- | --- |
| `EDNA_API_KEY` | Ваш API-ключ для edna Pulse. | - |
| `EDNA_BASE_URL` | Базовый URL API для edna. | `https://app.edna.ru` |
| `EDNA_IM_TYPE` | Тип используемого канала (например, `whatsapp`). | `whatsapp` |
| `EDNA_SEND_PATH` | Путь API для отправки сообщений. | `/api/messages/send` |

### amoCRM (Чаты / amojo)

Эти настройки необходимы для подключения к API Чатов amoCRM (amojo).

| Переменная | Описание | Значение по умолчанию |
| --- | --- | --- |
| `AMOCRM_AMOJO_BASE_URL` | Базовый URL для API amojo. | `https://amojo.amocrm.ru` |
| `AMOCRM_CHANNEL_ID` | ID вашего канала в amoCRM. | - |
| `AMOCRM_CHANNEL_SECRET` | Секретный ключ для вашего канала. | - |
| `AMOCRM_ACCOUNT_ID` | ID вашего аккаунта amoCRM. | - |
| `AMOCRM_CONNECT_TITLE` | Отображаемое имя для подключения интеграции. | `Integration Channel` |
| `AMOCRM_HOOK_API_VERSION`| Версия API вебхуков для использования. | `v2` |

### amoCRM (REST API - Опционально)

Эти переменные нужны, только если вы используете другие функции REST API amoCRM.

| Переменная | Описание | Значение по умолчанию |
| --- | --- | --- |
| `AMOCRM_BASE_URL` | Базовый URL вашего экземпляра amoCRM. | `https://your_subdomain.amocrm.ru` |
| `AMOCRM_TOKEN` | Ваш Bearer-токен для REST API amoCRM. | `your_amocrm_token` |


## Установка и запуск

Рекомендуемый способ запуска сервиса — использование Docker Compose.

1.  **Создайте файл `.env`**:
    Скопируйте файл `.env.sample` в `.env` и укажите ваши учетные данные для edna и amoCRM.
    ```bash
    cp .env.sample .env
    ```
    Как минимум, вам нужно установить `EDNA_API_KEY`, `AMOCRM_CHANNEL_ID`, `AMOCRM_CHANNEL_SECRET` и `AMOCRM_ACCOUNT_ID`.

2.  **Запустите с помощью Docker Compose**:
    ```bash
    docker-compose up --build
    ```
    Сервис будет доступен по адресу `http://localhost:28000`.

### Альтернатива: Сборка Docker вручную

Если вы предпочитаете не использовать Docker Compose, вы можете собрать и запустить контейнер вручную.

1.  **Создайте файл `.env`**, как описано выше.

2.  **Соберите Docker-образ**:
    ```bash
    docker build -t edna-amocrm-integration . -f src/Dockerfile
    ```

3.  **Запустите контейнер**:
    ```bash
    docker run -d --env-file .env -p 28000:8000 --name edna-amocrm-app edna-amocrm-integration
    ```
Сервис будет доступен по адресу `http://localhost:28000`.

## Примеры полезной нагрузки вебхуков

### Edna: Входящее сообщение

```json
{
    "id": "msg-12345",
    "imType": "whatsapp",
    "subject": "79001234567",
    "text": "Здравствуйте, у меня вопрос!",
    "fromClient": true
}
```

### Edna: Обновление статуса

```json
{
    "id": "msg-abcde",
    "status": "read"
}
```

### amoCRM: Входящий вебхук

```json
{
    "message": {
        "id": "chat-msg-67890",
        "text": "Здравствуйте, чем могу помочь?",
        "date": 1678886400
    },
    "sender": {
        "id": "user-1",
        "name": "Иван Петров"
    },
    "conversation": {
        "id": "chat-xyz"
    },
    "account": {
        "id": "acc-123",
        "subdomain": "youraccount"
    }
}
```