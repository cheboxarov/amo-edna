# Система источников чатов amo-edna интеграции

## Обзор

Система источников позволяет автоматически создавать и управлять источниками чатов в AmoCRM для интеграции с Edna. По умолчанию создается источник с названием "TeMa Edna".

## Настройка

### Важно: Включение множественных источников

**Для корректной работы системы источников необходимо включить "Множественные источники" в настройках интеграции в AmoCRM.**

1. Перейдите в AmoCRM → Настройки → Интеграции
2. Найдите вашу интеграцию amo-edna
3. Включите галочку **"Поддерживается ли работа с множественными источниками"**
4. Сохраните изменения

Без этого источники не будут корректно работать с API чатов.

### Переменные окружения

Добавьте в ваш `.env` файл:

```bash
# Настройки источников
AMOCRM_AUTO_CREATE_SOURCES=true
AMOCRM_TEMA_EDNA_SOURCE_NAME=TeMa Edna
AMOCRM_SOURCE_PIPELINE_ID=12345  # ID воронки продаж (рекомендуется указать)
AMOCRM_SOURCE_EXTERNAL_ID_PREFIX=tema_edna
```

### Параметры конфигурации

- `AMOCRM_AUTO_CREATE_SOURCES` - Включить/отключить автоматическое создание источников (по умолчанию: true)
- `AMOCRM_TEMA_EDNA_SOURCE_NAME` - Название источника (по умолчанию: "TeMa Edna")
- `AMOCRM_SOURCE_PIPELINE_ID` - ID воронки продаж для новых источников (обязательно для создания)
- `AMOCRM_SOURCE_EXTERNAL_ID_PREFIX` - Префикс для external_id новых источников

## Как это работает

### 1. Автоматическое создание источника

При запуске приложения система:

1. Проверяет существование источника "TeMa Edna"
2. Если источник найден - использует его
3. Если не найден - создает новый с указанным pipeline_id
4. Если pipeline_id не указан - берет его из существующего источника
5. **Сохраняет external_id источника в настройках приложения**

### 2. Использование в чатах

Все чаты, созданные через интеграцию amo-edna, будут автоматически привязаны к источнику "TeMa Edna":

- **Создание чата**: Использует источник "TeMa Edna" через `create_chat`
- **Отправка сообщений**: Все сообщения в чате отправляются с `source.external_id` в payload
- **Неразобранное**: Создается с правильным источником, а не "Робот"

### 3. Fallback режим

Если создание источника невозможно (например, из-за отсутствия прав или недоступности API), система переходит в fallback режим и создает чаты без привязки к источнику.

## Диагностика

### Запуск диагностических скриптов

#### Тестирование API источников:
```bash
cd src
python scripts/test_sources_api.py
```

Скрипт выполнит:
- Получение списка всех источников
- Поиск источника "TeMa Edna"
- Проверку pipeline_id
- Попытку создания тестового источника

#### Тестирование полной интеграции:
```bash
cd src
python scripts/test_integration_flow.py
```

Скрипт проверит:
- Создание/получение источника "TeMa Edna"
- Сохранение external_id в настройках
- Корректность всей цепочки интеграции

### Логи

Система логирует все операции с источниками. Основные логи:

#### Инициализация:
```
startup: Инициализация источника 'TeMa Edna'...
startup: Источник 'TeMa Edna' успешно инициализирован (ID: 12345, external_id: tema_edna_1699123456)
startup: External_id источника сохранен в настройках: tema_edna_1699123456
```

#### Работа с источниками:
```
INFO: Ищем существующий источник 'TeMa Edna'
INFO: Найден существующий источник 'TeMa Edna' с ID: 12345
INFO: Источник 'TeMa Edna' не найден, создаем новый
INFO: Успешно создан источник 'TeMa Edna' с ID: 12346
```

#### Отправка сообщений:
```
DEBUG: Используем external_id источника для сообщения: tema_edna_1699123456
DEBUG: Добавлен источник в payload текстового сообщения: external_id=tema_edna_1699123456
DEBUG: Добавлен источник в payload медиа-сообщения: external_id=tema_edna_1699123456
```

### Возможные ошибки

#### 400 Bad Request при создании источника

Причины:
- Отсутствует `pipeline_id`
- Недостаточно прав доступа
- Неверный формат данных

Решения:
1. Укажите `AMOCRM_SOURCE_PIPELINE_ID` в .env файле
2. Проверьте права токена доступа
3. Запустите диагностический скрипт для детального анализа

#### 403 Forbidden

Причина: Недостаточно прав для работы с источниками.

Решение: Проверьте, что токен имеет права на создание источников.

## API методы

### SourceProvider интерфейс

```python
# Поиск источника по названию
source = await provider.get_source_by_name("TeMa Edna")

# Поиск по external_id
source = await provider.get_source_by_external_id("tema_edna_123")

# Получение всех источников
sources = await provider.get_all_sources()

# Создание источника
new_source = Source(name="Test", external_id="test_123", pipeline_id=12345)
created = await provider.create_source(new_source)

# Удаление источника
await provider.delete_source("external_id")
```

### SourceManager

```python
# Гарантированное получение/создание источника "TeMa Edna"
source = await manager.ensure_tema_edna_source_exists()

# Получение существующего источника (без создания)
source = await manager.get_tema_edna_source()

# Очистка кеша
manager.clear_cache()
```

## Структура кода

```
src/
├── domain/
│   ├── models/
│   │   └── source.py          # Модель Source
│   └── ports/
│       └── source_provider.py # Интерфейс SourceProvider
├── infrastructure/
│   └── http_clients/
│       └── source_client.py   # AmoCrmSourceProvider реализация
├── use_cases/
│   └── source_manager.py      # SourceManager бизнес-логика
├── core/
│   └── config.py              # Настройки источников
└── scripts/
    └── test_sources_api.py    # Диагностический скрипт
```

## Безопасность

- Все запросы к API источников логируются
- Ошибки создания источников не останавливают работу приложения
- Fallback режим обеспечивает непрерывность работы
- Кеширование источников для оптимизации производительности

## Мониторинг

### Метрики для отслеживания

- Количество созданных источников
- Время создания источника
- Количество ошибок при работе с API источников
- Использование fallback режима

### Логи для анализа

```
startup: Инициализация источника 'TeMa Edna'...
startup: Источник 'TeMa Edna' успешно инициализирован (ID: 12345, external_id: tema_edna_1699123456)
use_cases: Используем источник 'TeMa Edna' с external_id: tema_edna_1699123456
```
